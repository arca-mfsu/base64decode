<!DOCTYPE HTML>
<html>
  <head>
    <link rel="stylesheet" href="./style.css">
    <script src="./blob_base64.js"></script>
    <script>
      initialize = function(){
        const textarea = document.getElementById("textarea");
        const button = document.getElementById("button");
        const input = document.getElementById("input");
        const base64 = window.location.hash.substring(1);
        let exceptionMessage = "";

        //bug catch
        try{atob(base64)}catch(e){
          exceptionMessage = "잘못된 base64 코드입니다. ";
        }
        
        //set input default
        if(!base64 || exceptionMessage){
          textarea.value = "";
          textarea.readOnly = false;
          textarea.placeholder = exceptionMessage + "여기에 base64 코드를 입력하거나 붙여넣기해주세요...";
          textarea.style = "";
          input.value = "";
          input.placeholder = "";
          input.style = "display:none";
          button.innerText = "디코드";
          button.onclick = decode;
          button.style = "";
          return;
        }
        
        // re-initialize
        const resultBinary = atob(base64);
        const result = binaryToUtf8(resultBinary);
        const fileExtension = getExtension(resultBinary);
        const fileName = decodeURIComponent(document.location.search.substring(1)) || "result";
        let isDownloadMode = false;
        let isResultMode = false;

        //check mode
        if(result.length < 4000)
          isResultMode = true;
        if(result.length > 300)
          isDownloadMode = true;

        
        //set output default
        textarea.value = result;
        textarea.readOnly = true;
        textarea.placeholder = "";
        textarea.style = isResultMode ? "" : "display:none";
        input.value = "";
        input.placeholder = fileName;
        input.style = isDownloadMode ? "" : "display:none";
        button.innerText = "다운로드";
        button.onclick = download;
        button.style = isDownloadMode ? "" : "display:none";

      }

      function binaryToUtf8(binary){
        const textDecoder = new TextDecoder('utf-8');
        const array = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
            array[i] = binary.charCodeAt(i);
        }
        return textDecoder.decode(array);
      }

      function getExtension(binary){
        if(binary.slice(0,4) === "\x50\x4B\x03\x04")
          return "zip";
        if(binary.slice(0,3) === "\xFF\xD8\xFF")
          return "jpg";
        if(binary.slice(0,8) === "\x89\x50\x4E\x47\x0D\x0A\x1A\x0A")
          return "png";
        if(binary.slice(0,3) === "\x47\x49\x46")
          return "gif";
        
        return "txt";
      }

      function getFileFullName(name, extension){
        const replacements = {'/':'／', '\\':'＼', ':':'：', '*':'＊', '"':'゛', '<':'＜', '>':'＞', '|':'｜'};
        const fullName = name + "." + extension;
        return fullName.replace(/[\/\\:*"<>|]/g, match=>replacements[match]);
      }
      
      decode = function(){
        const textarea = document.getElementById("textarea");
        window.location.hash = "#"+textarea.value;
      }

      download = function(){
        const input = document.getElementById("input");
        const base64 = window.location.hash.substring(1);
        const result = base64ToBlob(base64);
        const url = URL.createObjectURL(result);
        const fileName = input.value || input.placeholder || "rpgsave.zip";
        const fileExtension = fileName.includes(".") ? fileName.pop() : "txt";
        a = document.createElement("a");
        a.href = url;
        a.download = getFileFullName(fileName, fileExtension);
        a.style = "display:none";
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      window.onload = initialize;
      window.onhashchange = initialize;
    </script>
  </head>
  <body>
    <textarea id="textarea">
    </textarea>
    <input id="input">
    </input>
    <button id="button">
    </button>
  </body>
</html>
